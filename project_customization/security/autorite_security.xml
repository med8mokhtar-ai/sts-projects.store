<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data noupdate="0">

        <!-- read -->
        <!-- Règle d'accès pour project.project -->
        <record id="project_project_rule_autorite" model="ir.rule">
            <field name="name">Accès Autorité Projet</field>
            <field name="model_id" ref="project.model_project_project" />
            <field name="domain_force">[
                ('is_project_shared', '=', True),
                '|',
                ('autorite_contractante.id', '=', user.partner_id.id),
                ('autorite_contractante.id', 'child_of', user.partner_id.id)
            ]</field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
            <field name="perm_create" eval="False" />
            <field name="perm_unlink" eval="False" />
        </record>

        <!-- Règle d'accès pour project.feedback -->
        <record id="project_feedback_rule_autorite" model="ir.rule">
            <field name="name">Accès Autorité Feedback Projet</field>
            <field name="model_id" ref="project_customization.model_project_feedback" />
            <field name="domain_force">
                [
                    ('state', '=', 'draft'),
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="False" />
            <field name="perm_create" eval="False" />
            <field name="perm_unlink" eval="False" />
        </record>

        <!-- Règle d'accès pour project.stop.station -->
        <record id="project_stop_station_rule_autorite" model="ir.rule">
            <field name="name">Accès Autorité Station d'arrêt Projet</field>
            <field name="model_id" ref="project_customization.model_project_stop_station" />
            <field name="domain_force">
                [
                    ('state', '=', 'draft'),
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="False" />
            <field name="perm_create" eval="False" />
            <field name="perm_unlink" eval="False" />
        </record>

        <!-- Règle d'accès pour res.partner.appraisal -->
        <record id="res_partner_appraisal_rule_autorite" model="ir.rule">
            <field name="name">Accès Autorité Évaluation Partenaire</field>
            <field name="model_id" ref="project_customization.model_res_partner_appraisal" />
            <field name="domain_force">
                [
                    ('state', '=', 'draft'),
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="False" />
            <field name="perm_create" eval="False" />
            <field name="perm_unlink" eval="False" />
        </record>

        <!-- Règle d'accès pour project.avenant -->
        <record id="project_avenant_rule_autorite" model="ir.rule">
            <field name="name">Accès Autorité Avenant Projet</field>
            <field name="model_id" ref="model_project_avenant" />
            <field name="domain_force">
                [
                    ('state', '=', 'draft'),
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="False" />
            <field name="perm_create" eval="False" />
            <field name="perm_unlink" eval="False" />
        </record>

        <!-- Règle d'accès pour project.geolocation -->
        <record id="project_geolocation_rule_autorite" model="ir.rule">
            <field name="name">Accès Autorité Géolocalisation Projet</field>
            <field name="model_id" ref="project_customization.model_project_geolocation" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="False" />
            <field name="perm_create" eval="False" />
            <field name="perm_unlink" eval="False" />
        </record>

        <!-- Règle d'accès pour account.analytic.line.project -->
        <record id="account_analytic_line_project_rule_autorite" model="ir.rule">
            <field name="name">Accès Autorité Ligne Analytique Projet</field>
            <field name="model_id" ref="project_customization.model_account_analytic_line_project" />
            <field name="domain_force">
                [
                    ('state', '=', 'draft'),
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="False" />
            <field name="perm_create" eval="False" />
            <field name="perm_unlink" eval="False" />
        </record>
        <!-- Base rule: Autorités can see all their milestones but cannot modify -->
        <record id="project_milestone_rule_autorite" model="ir.rule">
            <field name="name">Accès Autorité Jalon Projet</field>
            <field name="model_id" ref="project_customization.model_project_milestone" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="False" />
            <field name="perm_create" eval="False" />
            <field name="perm_unlink" eval="False" />
        </record>
        <!-- Règle d'accès pour project.task -->
        <record id="project_task_rule_autorite" model="ir.rule">
            <field name="name">Accès Autorité Tâche Projet</field>
            <field name="model_id" ref="project.model_project_task" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="False" />
            <field name="perm_create" eval="False" />
            <field name="perm_unlink" eval="False" />
        </record>
        <!-- create -->
        <!-- Règle d'accès pour project.feedback -->
        <record id="project_feedback_rule_autorite_create" model="ir.rule">
            <field name="name">Accès Autorité Feedback Projet (Création)</field>
            <field name="model_id" ref="project_customization.model_project_feedback" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_create" eval="True" />
        </record>

        <!-- Règle d'accès pour project.stop.station -->
        <record id="project_stop_station_rule_autorite_create" model="ir.rule">
            <field name="name">Accès Autorité Station d'arrêt Projet (Création)</field>
            <field name="model_id" ref="project_customization.model_project_stop_station" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_create" eval="True" />
        </record>

        <!-- Règle d'accès pour res.partner.appraisal -->
        <record id="res_partner_appraisal_rule_autorite_create" model="ir.rule">
            <field name="name">Accès Autorité Évaluation Partenaire (Création)</field>
            <field name="model_id" ref="project_customization.model_res_partner_appraisal" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_create" eval="True" />
        </record>

        <!-- Règle d'accès pour project.avenant -->
        <record id="project_avenant_rule_autorite_create" model="ir.rule">
            <field name="name">Accès Autorité Avenant Projet (Création)</field>
            <field name="model_id" ref="model_project_avenant" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_create" eval="True" />
        </record>

        <!-- Règle d'accès pour project.geolocation -->
        <record id="project_geolocation_rule_autorite_create" model="ir.rule">
            <field name="name">Accès Autorité Géolocalisation Projet (Création)</field>
            <field name="model_id" ref="project_customization.model_project_geolocation" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_create" eval="True" />
        </record>

        <!-- Règle d'accès pour account.analytic.line.project -->
        <record id="account_analytic_line_project_rule_autorite_create" model="ir.rule">
            <field name="name">Accès Autorité Ligne Analytique Projet (Création)</field>
            <field name="model_id" ref="project_customization.model_account_analytic_line_project" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_create" eval="True" />
        </record>
        <!-- Allow Autorités to only create milestones -->
        <record id="project_milestone_rule_autorite_create" model="ir.rule">
            <field name="name">Accès Autorité Jalon Projet (Création)</field>
            <field name="model_id" ref="project_customization.model_project_milestone" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_create" eval="True" />
        </record>
        <!-- Règle d'accès pour project.task (Create permission) -->
        <record id="project_task_rule_autorite_create" model="ir.rule">
            <field name="name">Accès Autorité Tâche Projet (Création)</field>
            <field name="model_id" ref="project.model_project_task" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_create" eval="True" />
        </record>
        <!-- write -->
        <!-- Allow Autorités to edit model_project_feedback when in 'draft' -->
        <record id="project_feedback_rule_autorite_write" model="ir.rule">
            <field name="name">Accès Autorité Feedback Projet (Modification)</field>
            <field name="model_id" ref="project_customization.model_project_feedback" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    ('state', '=', 'draft'),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
        </record>
        <!-- Allow Autorités to edit project.stop.station when in 'draft' -->
        <record id="project_stop_station_rule_autorite_write" model="ir.rule">
            <field name="name">Accès Autorité Station d'arrêt Projet (Modification)</field>
            <field name="model_id" ref="project_customization.model_project_stop_station" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    ('state', '=', 'draft'),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
        </record>

        <!-- Allow Autorités to edit project.avenant when in 'draft' -->
        <record id="project_avenant_rule_autorite_write" model="ir.rule">
            <field name="name">Accès Autorité Avenant Projet (Modification)</field>
            <field name="model_id" ref="model_project_avenant" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    ('state', '=', 'draft'),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
        </record>


        <!-- Allow Autorités to edit account.analytic.line.project when in 'draft' -->
        <record id="account_analytic_line_project_rule_autorite_write" model="ir.rule">
            <field name="name">Accès Autorité Ligne Analytique Projet (Modification)</field>
            <field name="model_id" ref="project_customization.model_account_analytic_line_project" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    ('state', '=', 'draft'),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
        </record>

        <!-- Allow Autorités to edit project.task when in 'draft' -->
        <record id="project_task_rule_autorite_write" model="ir.rule">
            <field name="name">Accès Autorité Tâche Projet (Modification)</field>
            <field name="model_id" ref="project.model_project_task" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
            <field name="perm_unlink" eval="True" />
        </record>

        <!-- Allow Autorités to edit milestones ONLY if they are in 'draft' -->
        <record id="project_milestone_rule_autorite_write" model="ir.rule">
            <field name="name">Accès Autorité Jalon Projet (Modification)</field>
            <field name="model_id" ref="project_customization.model_project_milestone" />
            <field name="domain_force">
                [
                    ('project_id.is_project_shared', '=', True),
                    ('state', '=', 'draft'),
                    '|',
                    ('project_id.autorite_contractante.id', '=', user.partner_id.id),
                    ('project_id.autorite_contractante.id', 'child_of', user.partner_id.id)
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_autorite'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
        </record>

        <!-- ============ PROJECT BOS V RULES ============ -->
        <!-- ============ PROJECT ACCESS RULES ============ -->
        <record id="project_project_rule_bos" model="ir.rule">
            <field name="name">Accès Chef de projet</field>
            <field name="model_id" ref="project.model_project_project" />
            <field name="domain_force">[('autorite_contractante', '=',
                user.partner_id.parent_id.id), ('project_managers', 'in', [user.partner_id.id]),
                ('is_project_shared', '=', True)]</field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_bos'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
            <field name="perm_create" eval="False" />
            <field name="perm_unlink" eval="False" />
        </record>

        <!-- ============ TASK ACCESS RULES ============ -->

        <!-- Full Task Control -->
        <record id="project_task_rule_bos" model="ir.rule">
            <field name="name">Chef Projet: Tâches</field>
            <field name="model_id" ref="project.model_project_task" />
            <field name="domain_force">
                [
                ('project_id.autorite_contractante', '=', user.partner_id.parent_id.id),
                ('project_id.project_managers', 'in', [user.partner_id.id])
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_bos'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
            <field name="perm_create" eval="True" />
            <field name="perm_unlink" eval="True" />
        </record>

        <!-- ============ FINANCIAL ACCESS RULES ============ -->

        <!-- Analytic Lines -->
        <record id="account_analytic_line_project_rule_bos" model="ir.rule">
            <field name="name">Chef Projet: Lignes Analytiques</field>
            <field name="model_id" ref="project_customization.model_account_analytic_line_project" />
            <field name="domain_force">
                [
                ('project_id.autorite_contractante', '=', user.partner_id.parent_id.id),
                ('project_id.project_managers', 'in', [user.partner_id.id])
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_bos'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
            <field name="perm_create" eval="True" />
            <field name="perm_unlink" eval="False" />
        </record>

        <!-- ============ PROJECT DOCUMENTS RULES ============ -->

        <!-- Project Feedback -->
        <record id="project_feedback_rule_bos" model="ir.rule">
            <field name="name">Chef Projet: Feedback</field>
            <field name="model_id" ref="project_customization.model_project_feedback" />
            <field name="domain_force">
                [
                ('project_id.autorite_contractante', '=', user.partner_id.parent_id.id),
                ('project_id.project_managers', 'in', [user.partner_id.id])
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_bos'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
            <field name="perm_create" eval="True" />
            <field name="perm_unlink" eval="False" />
        </record>

        <!-- Project Milestones -->
        <record id="project_milestone_rule_bos" model="ir.rule">
            <field name="name">Chef Projet: Jalons</field>
            <field name="model_id" ref="project_customization.model_project_milestone" />
            <field name="domain_force">
                [
                ('project_id.autorite_contractante', '=', user.partner_id.parent_id.id),
                ('project_id.project_managers', 'in', [user.partner_id.id])
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_bos'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
            <field name="perm_create" eval="True" />
            <field name="perm_unlink" eval="False" />
        </record>

        <!-- Project Amendments -->
        <record id="project_avenant_rule_bos" model="ir.rule">
            <field name="name">Chef Projet: Avenants</field>
            <field name="model_id" ref="model_project_avenant" />
            <field name="domain_force">
                [
                ('project_id.autorite_contractante', '=', user.partner_id.parent_id.id),
                ('project_id.project_managers', 'in', [user.partner_id.id])
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_bos'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
            <field name="perm_create" eval="True" />
            <field name="perm_unlink" eval="False" />
        </record>

        <!-- ============ SPECIAL CASE RULES ============ -->

        <!-- Geolocation (Read-only) -->
        <record id="project_geolocation_rule_bos" model="ir.rule">
            <field name="name">Chef Projet: Géolocalisation</field>
            <field name="model_id" ref="project_customization.model_project_geolocation" />
            <field name="domain_force">
                [
                ('project_id.autorite_contractante', '=', user.partner_id.parent_id.id),
                ('project_id.project_managers', 'in', [user.partner_id.id])
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_bos'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="False" />
            <field name="perm_create" eval="False" />
            <field name="perm_unlink" eval="False" />
        </record>

        <!-- Partner Appraisal -->
        <record id="res_partner_appraisal_rule_bos" model="ir.rule">
            <field name="name">Chef Projet: Évaluations</field>
            <field name="model_id" ref="project_customization.model_res_partner_appraisal" />
            <field name="domain_force">
                [
                ('project_id.autorite_contractante', '=', user.partner_id.parent_id.id),
                ('project_id.project_managers', 'in', [user.partner_id.id])
                ]
            </field>
            <field name="groups" eval="[(4, ref('project_customization.group_project_bos'))]" />
            <field name="perm_read" eval="True" />
            <field name="perm_write" eval="True" />
            <field name="perm_create" eval="True" />
            <field name="perm_unlink" eval="False" />
        </record>


    </data>
</odoo>