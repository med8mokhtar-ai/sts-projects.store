<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!--project.milestone
        customized search view-->

        <record id="project_milestone_view_search" model="ir.ui.view">
            <field name="name">project.milestone.view.search</field>
            <field name="model">project.milestone</field>
            <field name="arch" type="xml">
                <search string="Search Milestone">
                    <field name="name" string="Nom" />
                    <field name="numero_marche" string="Numéro" />
                    <field name="autorite_contractante" string="Autorité contractante" />
                    <field name="titulaires" string="Titulaire" />
                    <separator />

                    <group expand="0" string="Group By">
                        <filter string="Type du marché" name="Type"
                            context="{'group_by': 'market_type_id'}" />
                        <filter string="Autorité contractante" name="Autorité"
                            context="{'group_by': 'autorite_contractante'}" />
                        <filter string="Titulaire" name="Titulaire"
                            context="{'group_by': 'titulaires'}" />
                    </group>
                </search>
            </field>
        </record>
        //Project milestone form view <record id="project_milestone_view_form" model="ir.ui.view">
            <field name="name">project.milestone.form.inherit</field>
            <field name="model">project.milestone</field>
            <field name="inherit_id" ref="project.project_milestone_view_form" />
            <field name="arch" type="xml">
                <xpath expr="//form" position="replace">
                    <!-- <attribute name="invisible">1</attribute> -->
                    <form string="Jalon">
                        <header>
                            <field name="state" widget="statusbar" />
                            <!-- <button name="action_sent" string="Soumettre" type="object"
                            invisible="state!='draft'" class="btn-primary" data-hotkey="v"
                            groups="project_customization.group_project_autorite"/>
                            <button name="action_confirm" string="Valider" type="object" invisible="state!='sent'"
                            class="btn-primary" data-hotkey="v"
                            groups="project.group_project_manager"/>
                            <button name="action_back_to_draft" string="Remettre en brouillon" type="object"
                            invisible="state!='sent'" class="btn-primary" data-hotkey="v"
                            groups="project.group_project_manager"/> -->
                            <button name="action_save" string="Enregistrer cette situation"
                                type="object" class="btn-primary" data-hotkey="v"
                                />
                        </header>
                        <sheet>
                            <div class="oe_button_box" name="button_box" groups="base.group_user">
                                <button class="oe_stat_button" type="object"
                                    name="action_view_task_history" icon="fa-history">
                                    Historique des tâches
                                </button>pro

                            </div>
                            <div class="oe_title pe-0">
                                <h1 class="d-flex flex-row justify-content-between">
                                    <field name="name" class="o_task_name text-truncate"
                                        readonly="state in ('sent','valide')" />
                                </h1>
                            </div>
                            <group>
                                <field name="project_id" invisible="1" />
                                <field name="numero_marche" />
                                <field name="market_type_id"
                                    options="{'no_open': true, 'no_create': true, 'no_edit': true}" />
                                <field name='currency_id' invisible="1" />
                                <field name="montant_initial" widget="monetary"
                                    options="{'currency_field': 'currency_id'}" />
                                <field name='autorite_contractante'
                                    options="{'no_open': true, 'no_create': true, 'no_edit': true}" />
                                <!-- <field name="retard_constate" hepl="Délai consommé - Délai
                                prévisionnel"/> -->
                                <field name="titulaires" string="Titulaire" widget="many2many_tags"
                                    options="{'no_open': true, 'no_create': true, 'no_edit': true}" />
                                <field name="company_id" invisible="1" />
                                <field name="funding_mode_ids" widget="many2many_tags" />
                            </group>
                            <group>
                                <!-- <field name="poids_poste"/> -->
                                <field name="pourcentage_realise"
                                    readonly="state in ('sent','valide')" sum="Total" />
                                <field name="date_start" readonly="state in ('sent','valide')" />
                                <field name="date_end" readonly="state in ('sent','valide')" />
                            </group>


                            <notebook>
                                <page string="Poste Associées">
                                    <field name="task_ids">
                                        <tree editable="bottom">
                                            <field name="name" />
                                            <field name="unit" />
                                            <field name="dao_a_realiser" />
                                            <field name="realisee" />
                                            <field name="reste_a_realiser" />
                                            <field name="pourcentage_realise" sum="Total" />
                                            <field name="date_debut" />
                                            <field name="date_fin" />
                                        </tree>
                                    </field>
                                </page>
                            </notebook>
                        </sheet>
                        <div class="oe_chatter" />
                        <!-- <field name="data_file" /> -->

                    </form>
                </xpath>
                <!-- <xpath expr="//field[@name='deadline']" position="before">
                    <field name="planned_weight" widget="progressbar_no_rounding" options="{'editable': true}"/>
                    <field name="effectif_rate" widget="progressbar_no_rounding" options="{'editable': true}"/>
                    <label for="date_start" string="Date planifiée"/>
                    <div class="w-100">
                        <div class="o_row">
                            <field name="date_start" widget="daterange" options="{&quot;related_end_date&quot;:
                &quot;date_end&quot;}"/>
                            <i class="fa fa-long-arrow-right mx-2 oe_edit_only" aria-label="Arrow icon" title="Arrow"/>
                            <i class="fa fa-long-arrow-right mx-2 oe_read_only" aria-label="Arrow icon" title="Arrow" />
                            <field name="date_end" widget="daterange" options="{&quot;related_start_date&quot;:
                &quot;date_start&quot;}"/>
                        </div>
                    </div>
                </xpath> -->
            </field>
        </record>
        <record
            id="action_project_jalon" model="ir.actions.act_window">
            <field name="name">Analyse des jalons</field>
            <field name="res_model">project.milestone</field>
            <field name="view_mode">kanban,tree,form,graph,pivot</field>
            <field name="context">{'group_by': ['state']}</field>
            <field name="search_view_id" ref="project_milestone_view_search" />

        </record>

        <menuitem
            id="menu_project_jalon" name="Analyse des jalons" parent="project.menu_project_report"
            action="action_project_jalon" sequence="8" />


        <!-- Define the action for the button -->
        <record id="action_milestone_get_graph"
            model="ir.actions.server">
            <field name="name">Get Milestone Graph</field>
            <field name="model_id" ref="project.model_project_milestone" />
            <!-- Replace with your actual model name -->
            <field name="state">code</field>
            <field name="code">action = self.action_get_graph()</field>
        </record>


        <!--        //Project milestone list view-->
        <record
            id="project_milestone_view_tree" model="ir.ui.view">
            <field name="name">project.milestone.tree.inherit</field>
            <field name="model">project.milestone</field>
            <field name="inherit_id" ref="project.project_milestone_view_tree" />
            <field name="arch" type="xml">


                <xpath expr="//tree[1]" position="attributes">
                    <attribute name="default_order">date_start asc, id asc</attribute>
                    <!-- <attribute name="default_group_by">date_start</attribute> -->
                </xpath>

                <xpath expr="//field[@name='deadline']" position="attributes">
                    <attribute name="column_invisible">1</attribute>
                </xpath>
                <xpath expr="//field[@name='is_reached']" position="attributes">
                    <attribute name="column_invisible">1</attribute>
                </xpath>
                <xpath expr="//field[@name='is_reached']" position="after">
                    <field name="project_id" />
                    <field name="pourcentage_prevue_realise" sum="Total" />
                    <field name="pourcentage_realise" sum="Total" />
                    <field name="date_start" />
                    <field name="date_end" />
                    <!-- <field name="currency_id" optional="hide"/> -->
                    <!-- <field name="milestone_debit" widget="monetary"/> -->

                </xpath>
            </field>
        </record>
        //Project milestone graph view <record id="project_milestone_graph" model="ir.ui.view">
            <field name="name">project.milestone.graph</field>
            <field name="model">project.milestone</field>
            <field name="arch" type="xml">
                <graph string="Jalons" sample="1" type="line">
                    <field name="name" type="row" />
                    <field name="effectif_rate" type="measure" />
                    <field name="planned_weight" type="measure" />
                </graph>
            </field>
        </record>
        //Project milestone Sharing <record id="project_sharing_milestone_view_tree"
            model="ir.ui.view">
            <field name="name">project.share.milestone.view.tree</field>
            <field name="model">project.milestone</field>
            <!-- <field name="inherit_id" ref="project.project_milestone_view_tree"/> -->
            <field name="arch" type="xml">
                <tree string="Jalons">
                    <field name="sequence" widget="handle" />
                    <field name="name" />
                    <field name="project_id" />
                    <!-- <field name="pourcentage_prevue_realise"/> -->
                    <field name="pourcentage_realise" sum="Total" />
                    <field name="date_start" />
                    <field name="date_end" />
                </tree>
            </field>
        </record>

        <record
            id="project_sharing_milestone_view_form" model="ir.ui.view">
            <field name="name">project.sharing_.milestone.form</field>
            <field name="model">project.milestone</field>
            <!-- <field name="inherit_id" ref="project.project_milestone_view_form"/> -->
            <field name="arch" type="xml">
                <form string="Jalons">
                    <header>
                        <field name="state" widget="statusbar" />
                        <!-- <button name="action_sent" string="Soumettre" type="object"
                        invisible="state!='draft'" class="btn-primary" data-hotkey="v"
                        groups="project_customization.group_project_autorite"/>
                        <button name="action_confirm" string="Valider" type="object" invisible="state!='sent'"
                        class="btn-primary" data-hotkey="v" groups="project.group_project_manager"/>
                        <button name="action_back_to_draft" string="Remettre en brouillon" type="object"
                        invisible="state!='sent'" class="btn-primary" data-hotkey="v"
                        groups="project.group_project_manager"/> -->
                        <button name="action_save" string="Enregistrer cette situation"
                            type="object" class="btn-primary" data-hotkey="v"
                            />
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box" groups="base.group_user">
                            <button class="oe_stat_button" type="object"
                                name="action_view_task_history" icon="fa-history">
                                Historique des tâches
                            </button>
                        </div>
                        <div class="oe_title pe-0">
                            <h1 class="d-flex flex-row justify-content-between">

                                <field name="name" class="o_task_name text-truncate"
                                    readonly="state in ('sent','valide')" />
                            </h1>
                        </div>
                        <group>
                            <group>
                                <field name="project_id" invisible="1" />
                                <field name="numero_marche"></field>
                                <field name="market_type_id"
                                    options="{'no_open': true, 'no_create': true, 'no_edit': true}" />

                                <!-- <field name='currency_id' invisible="1"/> -->


                            </group>
                            <group>
                                <field name='autorite_contractante'
                                    options="{'no_open': true, 'no_create': true, 'no_edit': true}" />
                                <!-- <field name="retard_constate" hepl="Délai consommé - Délai
                                prévisionnel"/> -->
                                <field name="titulaires" string="Titulaire" widget="many2many_tags"
                                    options="{'no_open': true, 'no_create': true, 'no_edit': true}" />

                            </group>
                        </group>

                        <group string="a saisir">

                            <field name="planned_weight" widget="progressbar_no_rounding"
                                options="{'editable': true}" readonly="state in ('sent','valide')" />
                            <field name="effectif_rate" widget="progressbar_no_rounding"
                                options="{'editable': true}" readonly="state in ('sent','valide')" />
                            <field name="cumulated_weight" widget="progressbar_no_rounding" />
                            <!-- <field name="milestone_debit" widget="monetary"/> -->

                            <label for="date_start" string="Date planifiée" />
                            <div class="w-100">
                                <div class="o_row">
                                    <field name="date_start" widget="daterange"
                                        options="{&quot;related_end_date&quot;: &quot;date_end&quot;}"
                                        readonly="state in ('sent','valide')" />
                                    <i class="fa fa-long-arrow-right mx-2 oe_edit_only"
                                        aria-label="Arrow icon" title="Arrow" />
                                    <i class="fa fa-long-arrow-right mx-2 oe_read_only"
                                        aria-label="Arrow icon" title="Arrow" />
                                    <field name="date_end" widget="daterange"
                                        options="{&quot;related_start_date&quot;: &quot;date_start&quot;}"
                                        readonly="state in ('sent','valide')" />
                                </div>
                            </div>
                        </group>

                    </sheet>
                </form>
            </field>
        </record>
        <record
            id="project_sharing_project_milestone_action" model="ir.actions.act_window">
            <field name="name">Jalons</field>
            <field name="res_model">project.milestone</field>
            <field name="view_mode">tree,form</field>
            <field name="view_ids"
                eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'tree', 'view_id': ref('project_customization.project_sharing_milestone_view_tree')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('project_customization.project_sharing_milestone_view_form')})]" />
            <field name="domain">[('project_id', '=', active_id)]</field>
            <field name="target">current</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Aucun Jalons trouvé. Créons-en un !
                </p>
                <p> Suivez la progression de vos retours depuis la création jusqu'à la finalisation.<br />
        Collaborez efficacement en discutant en temps réel ou par e-mail. </p>
            </field>
        </record>


        <record
            id="milestone_tree_action_view" model="ir.actions.act_window.view">
            <field name="sequence" eval="1" />
            <field name="view_mode">tree</field>
            <field name="view_id" ref="project_customization.project_sharing_milestone_view_tree" />
            <field name="act_window_id" ref="project_customization.action_project_milestones" />
        </record>
        <record
            id="milestone_tree_action_view" model="ir.actions.act_window.view">
            <field name="sequence" eval="1" />
            <field name="view_mode">tree</field>
            <field name="view_id" ref="project_customization.project_sharing_milestone_view_tree" />
            <field name="act_window_id" ref="project_customization.action_project_jalon" />
        </record>
        <record
            id="milestone_tree_action_view" model="ir.actions.act_window.view">
            <field name="sequence" eval="1" />
            <field name="view_mode">tree</field>
            <field name="view_id" ref="project_customization.project_sharing_milestone_view_tree" />
            <field name="act_window_id" ref="project_customization.action_project_milestones" />
        </record>


    </data>
</odoo>